# Iris Cartographer SLAM

We will learn how to do SLAM using cartographer, with drone in gazebo

**Note**: if you are new to drone simulation and PX4 check this [project](https://github.com/mohamedsayed18/Drone_simulation)

To install the cartographer package check their [documentation](https://google-cartographer-ros.readthedocs.io/en/latest/index.html)

I build a launch file which launch a drone with depth camera in a Gazebo world

``` bash
roslaunch drone iris_depth_camera.launch
```

The topics needed for SLAM:

* the point cloud topic `camera/depth/points`
* the imu topic `/mavros/imu/data`

We now done with the drone, Let's run the cartographer

source the cartographer package:
`source install_isolated/setup.bash`

launch the Cartographer SLAM path: catkin_ws/install_isolated/share/cartographer_ros/launch/my_robot.launch

```bash
roslaunch cartographer_ros my_robot.launch
```

### How I created this launch file

I create a copy of the `backpack_3d.lua`

```bash
cp install_isolated/share/cartographer_ros/configuration_files/backpack_3d.lua src/drone_pkg/config/my_robot.lua
```

I created new launch file `my_robot.launch`

```bash
cp install_isolated/share/cartographer_ros/launch/backpack_3d.launch src/drone_pkg/launch/my_robot.launch
```

created a [URDF] of my robot, this file will just describe the important links not the whole of the robot.

In `my_robot.lua` edited the number of point clouds depending on the type of sensors you have
`num_point_clouds = 1,`

In the `my_robot.launch` I referred to `my_robot.lua`

remapped the desired topic so cartographer can deal with it

```xml
    <remap from="imu" to="/mavros/imu/data" />
    <remap from="points2" to="camera/depth/points" />
```

Record the sensor data:

`rosbag record -a`

Validate the rosbag:

`cartographer_rosbag_validate -bag_filename your_bag.bag`

### Exploiting the map generated by Cartographer ROS

We will use the `cartographer_assets_writer`. It uses the bag file, pbstream file,
sensor extrinsics(/tf, URDF), and piple line configuration(.lua)

I will prepare this inputs one by one:

#### Bag file

I faced an [error](https://github.com/IntelRealSense/realsense-ros/issues/1076#issuecomment-586702026)
I will record only the desired topics `rosbag record camera/depth/points /mavros/imu/data`

#### Pbstream file

```
# Finish the first trajectory. No further data will be accepted on it.
rosservice call /finish_trajectory 0

# Ask Cartographer to serialize its current state.
# (press tab to quickly expand the parameter syntax)
rosservice call /write_state "{filename: '${HOME}/Downloads/b3-2016-04-05-14-14-00.bag.pbstream', include_unfinished_submaps: "true"}"
```

Now we can use the assest writer
```
roslaunch cartographer_ros assets_writer_backpack_3d.launch \
   bag_filenames:=${HOME}/Downloads/b3-2016-04-05-14-14-00.bag \
   pose_graph_filename:=${HOME}/Downloads/b3-2016-04-05-14-14-00.bag.pbstream
```

I was able to generate xyray images, I'll edit the file to generate ply file.

```
roslaunch cartographer_ros assets_writer_myrobot.launch bag_filenames:=/media/mohamed/C03CCDB43CCDA62E/tutorials/Innopolis/Year_2/Project/drone_ws/src/drone/bagfiles/2021-01-18-09-12-19.bag pose_graph_filename:=${HOME}/Downloads/b3-2016-04-05-14-14-00.bag.pbstream
```

I got the ply/pcd file generated `2021-01-18-09-12-19.bag_points.pcd`

#### Visualization of the point cloud

I viewed the ply file using meshlab. For pcd I'll try to reinstall pcd viewer later.

## Working on an offline data

1. I launched the drone in the willowgrage envirnoment
2. record a rosbag for the imu, depth 

`rostopic info 2021-01-25-12-00-34.bag`
```bash
path:        2021-01-25-12-00-34.bag
version:     2.0
duration:    3:58s (238s)
start:       Jan 01 1970 03:01:04.52 (64.52)
end:         Jan 01 1970 03:05:02.81 (302.81)
size:        468.2 MB
messages:    16854
compression: none [618/618 chunks]
types:       sensor_msgs/Imu         [6a62c6daae103f4ff57a132d6f95cec2]
             sensor_msgs/PointCloud2 [1158d486dd51d683ce2f1be655c3c181]
topics:      /mavros/imu/data      11916 msgs    : sensor_msgs/Imu
```

3. validate my rosbag

`cartographer_rosbag_validate -bag_filename 2021-01-25-12-00-34.bag`

some warnings we'll fix it later

4. I make a copy of demo_backpack_3d.launch and I call it "offline_robot.launch"
5. pbstream file is generated

```
rosservice call /write_state "{filename: '${HOME}/Downloads/b3-2016-04-05-14-14-00.bag.pbstream', include_unfinished_submaps: "true"}"
```

6. The assest writer to generate the ply file

```
roslaunch cartographer_ros assets_writer_myrobot.launch bag_filenames:=${HOME}/willow.bag pose_graph_filename:=${HOME}/willow.bag.pbstream
```

I was able to view the file using the meshlab

## errors and warnings

```
[ WARN] [1610626432.369576423, 125.792000000]: Could not compute submap fading: Could not find a connection between 'map' and 'base_link' because they are not part of the same tree.Tf has two or more unconnected trees.
```

when `cargo build --release` I got an error

## TODO

* make a detailed description of the launch, lau, and urdf
* new launch file to work with rosbag, and try offline rosbag